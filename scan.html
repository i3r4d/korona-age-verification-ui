<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age Verification</title>

    <!-- Reference to KORONA Plugin API Library -->
    <script type="text/javascript" src="korona-plugin-api.js"></script>

    <style>
        /* Styles remain the same as the previous version */
         body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; background-color: #f4f7f9; color: #333; margin: 10px; text-align: center; } .container { background-color: #ffffff; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 600px; width: 100%; } h1 { color: #2a3b4c; margin-bottom: 15px; font-size: 1.5em; } #instructions, #scan-area, #manual-entry-area, #result-area, #error-area, #warning-area { margin-top: 10px; padding: 8px; border-radius: 5px; } #instructions { font-size: 1.0em; color: #555; } #scan-area input[type="text"], #manual-entry-area input[type="text"] { /* Using text type */ padding: 12px; border: 1px solid #ccc; border-radius: 4px; width: calc(80% - 24px); margin-bottom: 10px; font-size: 1.1em; background-color: #fff; color: #333; font-family: inherit; } label { display: block; margin-bottom: 5px; font-weight: bold;} #result-area { border: 1px solid #d1e7dd; background-color: #f0fff4; color: #0f5132; font-weight: bold; } #error-area { border: 1px solid #f5c6cb; background-color: #fff0f1; color: #842029; font-weight: bold; text-transform: uppercase; } .hidden { display: none; } button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.0em; margin-top: 10px; transition: background-color 0.2s ease; margin-left: 5px; margin-right: 5px; font-family: inherit; } button:hover { background-color: #0056b3; } button#acknowledge-button { background-color: #6c757d; } button#acknowledge-button:hover { background-color: #5a6268; } hr { border: 0; height: 1px; background-color: #e0e0e0; margin: 20px 0; } #warning-area { margin-top: 15px; padding: 10px; border-radius: 5px; border: 1px solid #ffecb5; background-color: #fffbeb; color: #664d03; font-weight: bold; } #manual-entry-instructions { font-size: 0.85em; color: #555; margin-top: 5px; } #scan-input::placeholder, #manual-dob-input::placeholder { font-family: inherit; color: #999; opacity: 1; } #scan-input::-webkit-input-placeholder, #manual-dob-input::-webkit-input-placeholder { font-family: inherit; color: #999; } #scan-input::-moz-placeholder, #manual-dob-input::-moz-placeholder { font-family: inherit; color: #999; opacity: 1; } #scan-input:-ms-input-placeholder, #manual-dob-input:-ms-input-placeholder { font-family: inherit; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="page-title">Scan Customer's ID - Age Verification</h1> <!-- Title is generic now -->

        <!-- Scan Section -->
        <div id="scan-section">
             <div id="instructions">
                 Please scan the barcode on the back of the customer's Driver's License.
             </div>
             <div id="scan-area">
                 <input type="text" id="scan-input" name="scan-input" placeholder="Scan ID Here..." autocomplete="off" autofocus>
             </div>
        </div>

        <hr>

        <!-- Manual Entry Section -->
        <div id="manual-entry-section">
             <label for="manual-dob-input">OR Manually enter Date of Birth</label>
             <div id="manual-entry-area">
                 <input type="text" id="manual-dob-input" name="manual-dob-input" placeholder="MM/DD/YYYY" pattern="\d{2}/\d{2}/\d{4}" maxlength="10" inputmode="numeric">
                 <button id="manual-verify-button">Verify</button>
             </div>
             <div id="manual-entry-instructions">
                (Use only if scan fails *and* you have visually verified the ID is not expired)
             </div>
        </div>

        <!-- Result/Error/Warning Area -->
        <div id="result-area" class="hidden"></div>
        <div id="error-area" class="hidden"></div>
        <div id="warning-area" class="hidden"></div>
        <button id="acknowledge-button" class="hidden">Acknowledge Failure</button>

    </div>

    <!-- JavaScript (Complete - Conditional Payment Blocker) -->
    <script>
        // --- Configuration ---
        const REQUIRED_SECTOR_NUMBER = "1";
        const BACKEND_VERIFY_URL = "https://i3r4d.pythonanywhere.com/api/verify-id";
        const PAYMENT_BLOCK_MESSAGE = "Age verification required.";

        // --- DOM Elements ---
        let scanInput, manualDobInput, manualVerifyButton, resultArea, errorArea, warningArea, instructionsDiv, acknowledgeButton, scanSectionDiv, manualEntrySectionDiv, pageTitle;
        let posInfo = { number: null, name: null };
        let cashierInfo = { number: null, name: null };
        let processingScan = false;
        // --- NEW: Store how the page was invoked ---
        let invocationMode = 'total'; // Default to 'total' (implying blocker needed)

        // --- Initialization ---
        window.onload = function() {
            console.log("Window loaded.");

            // --- NEW: Read URL Parameter ---
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const triggerParam = urlParams.get('trigger');
                if (triggerParam && triggerParam.toLowerCase() === 'button') {
                    invocationMode = 'button';
                }
                console.log(`Invocation Mode determined as: ${invocationMode}`);
            } catch (e) {
                console.error("Error reading URL parameters:", e);
                // Keep default 'total' mode if error occurs
            }
            // -----------------------------

            // Get DOM elements
            scanInput = document.getElementById('scan-input'); /* ... and others ... */
            manualDobInput = document.getElementById('manual-dob-input');
            manualVerifyButton = document.getElementById('manual-verify-button');
            resultArea = document.getElementById('result-area');
            errorArea = document.getElementById('error-area');
            warningArea = document.getElementById('warning-area');
            instructionsDiv = document.getElementById('instructions');
            acknowledgeButton = document.getElementById('acknowledge-button');
            scanSectionDiv = document.getElementById('scan-section');
            manualEntrySectionDiv = document.getElementById('manual-entry-section');
            pageTitle = document.getElementById('page-title'); // Get title element

            if (!scanInput || !manualDobInput /*... etc ...*/) { /* ... fatal error ... */ return; }

             // Adjust title based on mode
             if (invocationMode === 'button') {
                 pageTitle.textContent = "Manual Age Verification";
             } else {
                 pageTitle.textContent = "Age Verification Required"; // Default/On Total title
             }


            // Check for KORONA API
            try {
                 if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api) {
                     console.log("KORONA Plugin API detected.");
                     korona_plugin_api.ready(initializePage);
                 } else { throw new Error("korona_plugin_api is not defined"); }
            } catch (error) {
                console.warn("KORONA Plugin API not found:", error.message);
                setupListeners(); scanInput.focus();
                displayWarning("Running outside KORONA POS. Verification/POS interactions disabled.");
            }
        };

        function initializePage() {
             try {
                console.log("KORONA Plugin API Ready.");
                const requestData = korona_plugin_api.request;
                const receipt = requestData?.receipt;

                // Capture POS/Cashier Info
                posInfo = requestData?.pos || { number: 'N/A', name: 'N/A' };
                cashierInfo = requestData?.cashier || { number: 'N/A', name: 'N/A' };
                console.log(`POS: ${posInfo.name} (${posInfo.number}), Cashier: ${cashierInfo.name} (${cashierInfo.number})`);

                console.log("Receipt data snippet available:", JSON.stringify(receipt?.sales?.slice(0,1) || {}, null, 2));

                const verificationStrictlyNeeded = isVerificationNeeded(receipt);

                // --- CONDITIONAL: Set Payment Block ONLY if invoked via 'total' trigger ---
                if (invocationMode === 'total') {
                    if (verificationStrictlyNeeded) {
                        console.log("On Total trigger: Age verification required. Setting payment block.");
                        safeSetPaymentBlocker(); // Block payment until verification succeeds
                    } else {
                        console.log("On Total trigger: No restricted items found. Skipping verification & block.");
                        safeBackToKorona(); // No block needed, just return
                        return; // Stop further initialization
                    }
                } else { // Invoked via button
                     console.log("Button trigger: Payment blocker will NOT be set.");
                     if (!verificationStrictlyNeeded) {
                         console.log("Button trigger: No restricted items found, but proceeding with UI for manual check.");
                         // Optionally add a subtle warning here if desired
                     }
                }
                // -----------------------------------------------------------------------

                setupListeners(); // Setup ALL listeners
                scanInput.focus(); // Focus scan input initially

            } catch (error) {
                console.error("Error during KORONA page initialization:", error);
                displayFatalError(`Initialization Error: ${error.message || 'Could not process KORONA data.'}`);
                // If init fails, payment might remain blocked if it was set. User must cancel/fix.
            }
        }

        // --- Helper Functions ---
        function isVerificationNeeded(receipt) {
             if (!receipt || !receipt.sales || !Array.isArray(receipt.sales)) {
                console.warn("Receipt data missing/invalid for verification check."); return false;
            }
            const needed = receipt.sales.some(item => item && item.sector?.number === REQUIRED_SECTOR_NUMBER);
            console.log(`isVerificationNeeded check result: ${needed}`);
            return needed;
        }

        // --- Event Listeners Setup ---
        function setupListeners() {
            // (Listeners remain the same as previous version)
             if (!scanInput || !manualDobInput /*... etc ...*/) { /* ... */ return; }
             scanInput.addEventListener('keydown', function(event) { /* ... */ if (event.key === 'Enter') { /* ... verifyIdOnBackend({ scanData: ... }); ... */ } });
             manualDobInput.addEventListener('input', function(e) { /* ... format MM/DD/YYYY ... */ });
             manualDobInput.addEventListener('focus', function() { /* ... safeShowOsk() ... */ });
             manualDobInput.addEventListener('click', function() { /* ... safeShowOsk() ... */ });
             manualVerifyButton.addEventListener('click', function() { /* ... verifyIdOnBackend({ manualDob: ... }); ... */ });
             acknowledgeButton.addEventListener('click', function() { console.log("Acknowledge Failure clicked."); safeBackToKorona(); }); // No blocker logic needed here
        }

        // --- Backend Communication ---
        async function verifyIdOnBackend(payload) {
             // (This function remains largely the same - still sends POS/Cashier info)
             clearMessages(); if(instructionsDiv) instructionsDiv.textContent = "Verifying...";
             payload.posId = posInfo.number; payload.posName = posInfo.name;
             payload.cashierId = cashierInfo.number; payload.cashierName = cashierInfo.name;
             console.log("Sending payload to backend:", JSON.stringify(payload));

             if (typeof korona_plugin_api === 'undefined' || !korona_plugin_api) { /* ... browser simulation ... */ return; }

             try { /* ... fetch call ... */
                 const response = await fetch(BACKEND_VERIFY_URL, { /* ... */ body: JSON.stringify(payload) });
                 /* ... handle response ... */
                 const result = JSON.parse(responseText);
                 handleVerificationResult(result);
             } catch (error) { /* ... handle fetch error ... */
                  // No blocker logic needed here
                 displayError(`System Error: ${error.message || 'Failed to connect.'}`, false);
                 enableInputs(); processingScan = false;
             }
        }

        // --- Handling Verification Result ---
        function handleVerificationResult(result) {
            processingScan = false;

            if (result.success === true) {
                console.log("Verification Successful:", result.message);
                displaySuccess(`Verification Success: ${result.message}`);
                safeAddKoronaReceiptInfo();

                // --- CONDITIONAL: Unset Payment Block ONLY if invoked via 'total' trigger ---
                if (invocationMode === 'total') {
                    console.log("On Total trigger successful: Unsetting payment block.");
                    safeUnsetPaymentBlocker(); // <<< Only unset if blocker was potentially set
                } else {
                    console.log("Button trigger successful: No payment block action needed.");
                }
                // -------------------------------------------------------------------------

                setTimeout(() => {
                     console.log("Returning control to KORONA POS after success.");
                     safeBackToKorona(); // Return AFTER potentially unblocking
                }, 1500);
             } else {
                 console.warn("Verification Failed:", result.message);
                 // (Failure message processing remains the same)
                 let failureReason = "VERIFICATION FAILED - SALE DENIED"; const backendMessage = result.message || ""; let allowRetry = false;
                 /* ... determine failureReason and allowRetry ... */

                 // --- No blocker logic needed on failure ---
                 displayError(failureReason, !allowRetry);

                 if (allowRetry) { /* ... enable inputs ... */ }
                 else { /* ... hide inputs, show acknowledge ... */ }
            }
        }

        // --- Safe Wrappers for KORONA API Calls ---

        // *** Set Payment Blocker (Now only called conditionally) ***
        function safeSetPaymentBlocker() {
            // Only attempts to set if API is available
            try {
                 if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api?.response?.setReceiptPaymentBlockingIndicator) {
                     console.log(`Requesting KORONA to set payment blocker: '${PAYMENT_BLOCK_MESSAGE}'`);
                     korona_plugin_api.response.setReceiptPaymentBlockingIndicator({ message: PAYMENT_BLOCK_MESSAGE });
                 } else { console.warn("Cannot set payment blocker - API unavailable."); }
            } catch(e) { console.error("Error calling setReceiptPaymentBlockingIndicator:", e); }
        }

        // *** Unset Payment Blocker (Now only called conditionally) ***
        function safeUnsetPaymentBlocker() {
             // Only attempts to unset if API is available
            try {
                 if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api?.response?.unsetReceiptPaymentBlockingIndicator) {
                     console.log("Requesting KORONA to unset payment blocker.");
                     korona_plugin_api.response.unsetReceiptPaymentBlockingIndicator();
                 } else { console.warn("Cannot unset payment blocker - API unavailable."); }
            } catch(e) { console.error("Error calling unsetReceiptPaymentBlockingIndicator:", e); }
        }

        // (safeShowOsk, safeBackToKorona, safeAddKoronaReceiptInfo remain the same)
        function safeShowOsk() { try { if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api?.showOsk) { korona_plugin_api.showOsk(); } else { console.warn("Cannot call showOsk() - API unavailable."); } } catch(e) { console.error("Error calling showOsk:", e); } }
        function safeBackToKorona() { try { if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api?.backToKorona) { korona_plugin_api.backToKorona(); } else { /* ... browser mode ... */ } } catch(e) { console.error("Error calling backToKorona:", e); } }
        function safeAddKoronaReceiptInfo() { try { const ts=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); const pl={key:"Age Verified",value:`OK @ ${ts}`}; if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api?.response?.addReceiptAdditionalInfo) { korona_plugin_api.response.addReceiptAdditionalInfo(pl); } else { console.warn("Cannot add receipt info."); } } catch(e) { console.error("Error calling addReceiptAdditionalInfo:", e); } }


        // --- UI Update Functions ---
        // (No changes needed in these functions)
        function disableInputs() { /* ... */ } function enableInputs() { /* ... */ } function displaySuccess(message) { /* ... */ } function displayError(message, showAcknowledge) { /* ... */ } function displayWarning(message) { /* ... */ } function displayFatalError(message) { /* ... */ } function clearMessages() { /* ... */ }

    </script>
</body>
</html>
