<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age Verification</title>

    <!-- Reference to KORONA Plugin API Library -->
    <script type="text/javascript" src="korona-plugin-api.js"></script>

    <style>
        /* Styles remain the same as the previous version */
         body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; background-color: #f4f7f9; color: #333; margin: 10px; text-align: center; } .container { background-color: #ffffff; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 600px; width: 100%; } h1 { color: #2a3b4c; margin-bottom: 15px; font-size: 1.5em; } #instructions, #scan-area, #manual-entry-area, #result-area, #error-area, #warning-area { margin-top: 10px; padding: 8px; border-radius: 5px; } #instructions { font-size: 1.0em; color: #555; } #scan-area input[type="text"], #manual-entry-area input[type="text"] { /* Using text type */ padding: 12px; border: 1px solid #ccc; border-radius: 4px; width: calc(80% - 24px); margin-bottom: 10px; font-size: 1.1em; background-color: #fff; color: #333; font-family: inherit; } label { display: block; margin-bottom: 5px; font-weight: bold;} #result-area { border: 1px solid #d1e7dd; background-color: #f0fff4; color: #0f5132; font-weight: bold; } #error-area { border: 1px solid #f5c6cb; background-color: #fff0f1; color: #842029; font-weight: bold; text-transform: uppercase; } .hidden { display: none; } button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.0em; margin-top: 10px; transition: background-color 0.2s ease; margin-left: 5px; margin-right: 5px; font-family: inherit; } button:hover { background-color: #0056b3; } button#acknowledge-button { background-color: #6c757d; } button#acknowledge-button:hover { background-color: #5a6268; } hr { border: 0; height: 1px; background-color: #e0e0e0; margin: 20px 0; } #warning-area { margin-top: 15px; padding: 10px; border-radius: 5px; border: 1px solid #ffecb5; background-color: #fffbeb; color: #664d03; font-weight: bold; } #manual-entry-instructions { font-size: 0.85em; color: #555; margin-top: 5px; } #scan-input::placeholder, #manual-dob-input::placeholder { font-family: inherit; color: #999; opacity: 1; } #scan-input::-webkit-input-placeholder, #manual-dob-input::-webkit-input-placeholder { font-family: inherit; color: #999; } #scan-input::-moz-placeholder, #manual-dob-input::-moz-placeholder { font-family: inherit; color: #999; opacity: 1; } #scan-input:-ms-input-placeholder, #manual-dob-input:-ms-input-placeholder { font-family: inherit; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scan Customer's ID - Age Verification Required</h1>

        <!-- Scan Section -->
        <div id="scan-section">
             <div id="instructions">
                 Please scan the barcode on the back of the customer's Driver's License.
             </div>
             <div id="scan-area">
                 <input type="text" id="scan-input" name="scan-input" placeholder="Scan ID Here..." autocomplete="off" autofocus>
             </div>
        </div>

        <hr>

        <!-- Manual Entry Section -->
        <div id="manual-entry-section">
             <label for="manual-dob-input">OR Manually enter Date of Birth</label>
             <div id="manual-entry-area">
                 <input type="text" id="manual-dob-input" name="manual-dob-input" placeholder="MM/DD/YYYY" pattern="\d{2}/\d{2}/\d{4}" maxlength="10" inputmode="numeric">
                 <button id="manual-verify-button">Verify</button>
             </div>
             <div id="manual-entry-instructions">
                (Use only if scan fails *and* you have visually verified the ID is not expired)
             </div>
        </div>

        <!-- Result/Error/Warning Area -->
        <div id="result-area" class="hidden"></div>
        <div id="error-area" class="hidden"></div>
        <div id="warning-area" class="hidden"></div>
        <button id="acknowledge-button" class="hidden">Acknowledge Failure</button>

    </div>

    <!-- JavaScript (Complete - Payment Blocker Removed) -->
    <script>
        // --- Configuration ---
        const REQUIRED_SECTOR_NUMBER = "1"; // Still used to check if verification is *relevant*
        const BACKEND_VERIFY_URL = "https://i3r4d.pythonanywhere.com/api/verify-id";
        // const PAYMENT_BLOCK_MESSAGE = "Age verification required."; // No longer needed

        // --- DOM Elements ---
        let scanInput, manualDobInput, manualVerifyButton, resultArea, errorArea, warningArea, instructionsDiv, acknowledgeButton, scanSectionDiv, manualEntrySectionDiv;
        let posInfo = { number: null, name: null };
        let cashierInfo = { number: null, name: null };
        let processingScan = false;

        // --- Initialization ---
        window.onload = function() {
            console.log("Window loaded.");
            // Get DOM elements (same as before)
            scanInput = document.getElementById('scan-input');
            manualDobInput = document.getElementById('manual-dob-input');
            manualVerifyButton = document.getElementById('manual-verify-button');
            resultArea = document.getElementById('result-area');
            errorArea = document.getElementById('error-area');
            warningArea = document.getElementById('warning-area');
            instructionsDiv = document.getElementById('instructions');
            acknowledgeButton = document.getElementById('acknowledge-button');
            scanSectionDiv = document.getElementById('scan-section');
            manualEntrySectionDiv = document.getElementById('manual-entry-section');

            if (!scanInput || !manualDobInput /*... etc ...*/) { /* ... fatal error ... */ return; }

            // Check for KORONA API
            try {
                 if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api) {
                     console.log("KORONA Plugin API detected. Registering ready callback.");
                     korona_plugin_api.ready(initializePage);
                 } else { throw new Error("korona_plugin_api is not defined"); }
            } catch (error) {
                console.warn("KORONA Plugin API not found:", error.message);
                setupListeners(); scanInput.focus();
                displayWarning("Running outside KORONA POS. Verification/POS interactions disabled.");
            }
        };

        function initializePage() {
             try {
                console.log("KORONA Plugin API Ready. Initializing page.");
                const requestData = korona_plugin_api.request;
                const receipt = requestData?.receipt;

                // Capture POS/Cashier Info (still useful for logging)
                posInfo = requestData?.pos || { number: 'N/A', name: 'N/A' };
                cashierInfo = requestData?.cashier || { number: 'N/A', name: 'N/A' };
                console.log(`POS: ${posInfo.name} (${posInfo.number}), Cashier: ${cashierInfo.name} (${cashierInfo.number})`);

                console.log("Receipt data snippet available:", JSON.stringify(receipt?.sales?.slice(0,1) || {}, null, 2));

                // Optional: Check if relevant items exist even with button press
                // If you remove this check, the UI will *always* show, even if no Sector 1 items are present.
                if (!isVerificationNeeded(receipt)) {
                    console.log(`No items from Sector ${REQUIRED_SECTOR_NUMBER} found on receipt when button pressed. Showing UI anyway, but verification might not be strictly required yet.`);
                    // Or optionally, you could skip:
                    // displayWarning("No age-restricted items found on receipt.");
                    // setTimeout(safeBackToKorona, 2000); // Return automatically if desired
                    // return;
                }

                // --- Payment Blocker is NOT set here for button trigger ---

                setupListeners(); // Setup ALL listeners
                scanInput.focus(); // Focus scan input initially

            } catch (error) {
                console.error("Error during KORONA page initialization:", error);
                displayFatalError(`Initialization Error: ${error.message || 'Could not process KORONA data.'}`);
            }
        }

        // --- Helper Functions ---
        function isVerificationNeeded(receipt) {
             // This check is now optional for the button flow, but can prevent unnecessary display
             // if the user presses the button before adding restricted items.
             if (!receipt || !receipt.sales || !Array.isArray(receipt.sales)) {
                console.warn("Receipt data missing or invalid for verification check.");
                return false; // Assume not needed if data is bad
            }
            const needed = receipt.sales.some(item => item && item.sector?.number === REQUIRED_SECTOR_NUMBER);
            console.log(`isVerificationNeeded check result: ${needed}`);
            return needed;
        }

        // --- Event Listeners Setup ---
        function setupListeners() {
             if (!scanInput || !manualDobInput /*... etc ...*/) { console.error("Listeners setup aborted."); return; }

             // Scan Input Listener
             scanInput.addEventListener('keydown', function(event) {
                 if (event.key === 'Enter' || event.keyCode === 13) {
                     event.preventDefault(); if (processingScan) return; processingScan = true;
                     setTimeout(() => {
                         const scannedData = scanInput.value.trim();
                         if (scannedData) {
                             disableInputs(); if(instructionsDiv) instructionsDiv.textContent = "Processing...";
                             verifyIdOnBackend({ scanData: scannedData });
                         } else { displayError("Scan input empty.", false); enableInputs(); processingScan = false; }
                     }, 100);
                 }
             });

             // Manual DOB Input Formatting
             manualDobInput.addEventListener('input', function(e) { /* ... format MM/DD/YYYY ... */ let v = e.target.value.replace(/\D/g,''); if(v.length>2&&v.length<=4) v=v.slice(0,2)+'/'+v.slice(2); else if(v.length>4) v=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4,8); e.target.value=v; });

             // Manual DOB Input Focus/Click Listener
             manualDobInput.addEventListener('focus', function() { console.log("Manual DOB focus"); safeShowOsk(); });
             manualDobInput.addEventListener('click', function() { console.log("Manual DOB click"); safeShowOsk(); });

            // Manual Verify Button Listener
            manualVerifyButton.addEventListener('click', function() {
                if (processingScan) return; processingScan = true;
                const manualDobValue = manualDobInput.value.trim();
                const dateFormat = /^\d{2}\/\d{2}\/\d{4}$/;
                if (!dateFormat.test(manualDobValue)) { displayError("Invalid date format: MM/DD/YYYY.", false); manualDobInput.focus(); processingScan = false; return; }
                disableInputs(); if(instructionsDiv) instructionsDiv.textContent = "Processing...";
                verifyIdOnBackend({ manualDob: manualDobValue });
            });

            // Acknowledge Button Listener
            acknowledgeButton.addEventListener('click', function() {
                console.log("Acknowledge Failure button clicked. Returning to POS.");
                // No payment block actions needed here
                safeBackToKorona();
            });
        }

        // --- Backend Communication ---
        async function verifyIdOnBackend(payload) {
            clearMessages(); if(instructionsDiv) instructionsDiv.textContent = "Verifying...";
            // Add POS/Cashier info
            payload.posId = posInfo.number; payload.posName = posInfo.name;
            payload.cashierId = cashierInfo.number; payload.cashierName = cashierInfo.name;
            console.log("Sending payload to backend:", JSON.stringify(payload));

            // Browser Mode Simulation (no changes needed)
             if (typeof korona_plugin_api === 'undefined' || !korona_plugin_api) { /* ... */ return; }

            // Actual Backend Call (no changes needed in fetch itself)
            try {
                const response = await fetch(BACKEND_VERIFY_URL, { /* ... */ body: JSON.stringify(payload) });
                const responseText = await response.text(); /* ... logging ... */
                if (!response.ok) { /* ... error handling ... */ throw new Error(errorMsg); }
                const result = JSON.parse(responseText);
                handleVerificationResult(result);
            } catch (error) {
                 console.error("Backend comms error:", error); /* ... error display ... */
                 // No payment block actions needed on error
                 displayError(`System Error: ${error.message || 'Failed to connect.'}`, false);
                 enableInputs(); processingScan = false;
            }
        }

        // --- Handling Verification Result ---
        function handleVerificationResult(result) {
            processingScan = false;

            if (result.success === true) {
                console.log("Verification Successful:", result.message);
                displaySuccess(`Verification Success: ${result.message}`);
                safeAddKoronaReceiptInfo(); // Still useful to add receipt info

                // --- Payment Blocker is NOT unset here ---

                setTimeout(() => {
                     console.log("Returning control to KORONA POS after success.");
                     safeBackToKorona();
                }, 1500);
             } else {
                 console.warn("Verification Failed:", result.message);
                 // Failure message processing (same as before)
                 let failureReason = "VERIFICATION FAILED - SALE DENIED"; const backendMessage = result.message || ""; let allowRetry = false;
                 if (backendMessage.toUpperCase().includes("UNDER 21")) { failureReason = "DENY SALE - CUSTOMER IS UNDER 21"; }
                 else if (backendMessage.toUpperCase().includes("EXPIRED")) { failureReason = "DENY SALE - CUSTOMER'S ID IS EXPIRED"; }
                 else if (backendMessage.toLowerCase().includes("error reading id") || /* ... */ ) { failureReason = `${backendMessage}`; allowRetry = true; if(errorArea) errorArea.style.textTransform = 'none'; }
                 else { failureReason = backendMessage.toUpperCase(); }

                 // --- No payment block actions needed on failure ---
                 displayError(failureReason, !allowRetry);

                 if (allowRetry) {
                     if(instructionsDiv) instructionsDiv.textContent = "Error processing ID. Try again or use manual entry.";
                     enableInputs();
                 } else {
                     if(instructionsDiv) instructionsDiv.textContent = "Verification Failed. Acknowledge to return to POS.";
                     if(scanSectionDiv) scanSectionDiv.classList.add('hidden');
                     if(manualEntrySectionDiv) manualEntrySectionDiv.classList.add('hidden');
                     if(acknowledgeButton) acknowledgeButton.classList.remove('hidden');
                 }
            }
        }

        // --- Safe Wrappers for KORONA API Calls ---

        // *** REMOVED safeSetPaymentBlocker() and safeUnsetPaymentBlocker() functions ***

        function safeShowOsk() { try { if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api?.showOsk) { korona_plugin_api.showOsk(); } else { console.warn("Cannot call showOsk() - API unavailable."); } } catch(e) { console.error("Error calling showOsk:", e); } }
        function safeBackToKorona() { try { if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api?.backToKorona) { korona_plugin_api.backToKorona(); } else { /* ... browser mode ... */ } } catch(e) { console.error("Error calling backToKorona:", e); } }
        function safeAddKoronaReceiptInfo() { try { const ts=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); const pl={key:"Age Verified",value:`OK @ ${ts}`}; if (typeof korona_plugin_api !== 'undefined' && korona_plugin_api?.response?.addReceiptAdditionalInfo) { korona_plugin_api.response.addReceiptAdditionalInfo(pl); } else { console.warn("Cannot add receipt info."); } } catch(e) { console.error("Error calling addReceiptAdditionalInfo:", e); } }

        // --- UI Update Functions ---
        // (No changes needed in these)
        function disableInputs() { /* ... */ } function enableInputs() { /* ... */ } function displaySuccess(message) { clearMessages(); if(resultArea) { resultArea.textContent = message; resultArea.classList.remove('hidden'); } if(scanSectionDiv) scanSectionDiv.classList.add('hidden'); if(manualEntrySectionDiv) manualEntrySectionDiv.classList.add('hidden'); } function displayError(message, showAcknowledge) { clearMessages(); if(errorArea) { errorArea.textContent = message; errorArea.classList.remove('hidden'); } if(showAcknowledge && acknowledgeButton) { acknowledgeButton.classList.remove('hidden'); } } function displayWarning(message) { /* ... */ } function displayFatalError(message) { /* ... */ } function clearMessages() { /* ... */ }

    </script>
</body>
</html>
